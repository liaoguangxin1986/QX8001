#include "i2c1_driver.h"
#include "gpio.h"
#include "cfg.h"
#include "dsp_cfg.h"
#include "sys.h"

/**
  * @brief  initial sensor ov2281.
  * @param  none
  *         
  * @retval none
  */
void ov2281_init(void)
{
	GPIO0_CTRL  = 0x00000001  ;//enable gpio0 clock
	rGPIODIR   |= (1<<0)|(1<<1)     ;//enable gaio0
	rGPIO0DATA |= (1<<0)      ;//gpio0=1;
	rGPIO0DATA &=~(1<<0)      ;//gpio0=0;
	delay(3000)               ;//delay >2ms
	rGPIO0DATA |= (1<<0)      ;//gpio0=1;
	delay(40000)              ;//delay >2ms
		
		

			
			

	//==================================================================
	//                OV2281 I2C config                                |
	//---|-------------------------------------------------------------|
	//[1]| PAD input fre_clk |  26 MHz                                 |
	//---|-------------------|-----------------------------------------|
	//[2]| PHY_clk           |  988MHz                                 |
	//---|-------------------|-----------------------------------------|
	//[3]| pixel_clk         |  988/8= 123.5MHz                        |
	//---|-------------------|-----------------------------------------|
	//[4]| output image      |  1920*1080                              |
	//---|-------------------|-----------------------------------------|
	//[5]| frame rate        |  30fps                                  |
	//==================================================================
			
	//==================================================================
	// Reset and standby mode enable
	//==================================================================
	i2c1_wr_8data(0x0103,0x01);// Reset OV2281
	delay(3000);
	i2c1_wr_8data(0x0103,0x00); 
	delay(40000);
	i2c1_wr_8data(0x0100,0x00);// standby mode enable
	//==================================================================
	// input 26MHz clock
	// 988MHz DPHY_clock
	// 988/8=123.5 Pclk
	//==================================================================
	//-------------------------
	// PLL1 set
	//-------------------------
	i2c1_wr_8data(0x030a,0x00);//pre_div0    --[0]   ---0/1 = /1/2                                                 ----26/1  =26
	i2c1_wr_8data(0x0300,0x02);//pre_div     --[2:0] ---000/001/010/011/100/101/110/111=/1/1.5/2/2.5/3/4/6/8       ----26/6  =4   										  
	i2c1_wr_8data(0x0301,0x00);//multi[9:8]  --[1:0]                                                               
	i2c1_wr_8data(0x0302,0x4c);//multi[7:0]  --[7:0] --- 0x * 0x                                                   ----4*105= 420                 
	i2c1_wr_8data(0x0303,0x00);//m-divder    --[3:0] ---1+ m-divder                                                ----420/2 =210  -----output for PHY_Clock 
	i2c1_wr_8data(0x0304,0x03);//mipi div    --[1:0] ---00/01/10/11 = /4/5/6/8                                     ----210/8 =26 
	i2c1_wr_8data(0x3020,0x93);//pixel div   --[3]   ---0/1 = /1/2                                                 ----26/1  =26   -----output for pixel_Clock 
	i2c1_wr_8data(0x0305,0x01);//{from multi[9:0]} sys_pre_div --[1:0] --- 00/01/10/11 = /3/4/5/6                  ----420/4 =105  
	i2c1_wr_8data(0x0306,0x01);//sys_div     --[0]   ---0/1 = /1/2                                                 ----105/2 =52   ------output for PLL1_sys_clk 
	//-------------------------
	// PLL2 set
	//-------------------------
	i2c1_wr_8data(0x0312,0x02); //pre_div0   --[4]   ---0/1 = /1/2                                                 ----26/1 =26
	i2c1_wr_8data(0x030b,0x00); //pre_div    --[2:0] ---000/001/010/011/100/101/110/111=/1/1.5/2/2.5/3/4/6/8       ----26/2 =13										  
	i2c1_wr_8data(0x030c,0x00); //multi[9:8] --[1:0]                                                               
	i2c1_wr_8data(0x030d,0x1e); //multi[7:0] --[7:0] --- 0x * 0x                                                   ----13*30 =390
	i2c1_wr_8data(0x0312,0x02); //dac_div    --[3:0] --- dac_div                                                   ----390/2 =195 ------output for PLL2_dac_clk
	i2c1_wr_8data(0x030f,0x07); //{from multi[9:0]} sys_pre_div --[3:0] --- 0x**                                   ----390/16=24             
	i2c1_wr_8data(0x030e,0x00); //sys_div    --[2:0] --- 000/001/010/011/100/101/110/111=/1/1.5/2/2.5/3/3.5/4/5    ----24/1  =24  ------output for PLL2_sys_clk
	i2c1_wr_8data(0x3032,0x80); //Sclk_mux0  --[7]   --- if=1,use PLL2_sys_clk,else use PLL1_sys_clk               ---- use PLL2_sys_clk=24
	i2c1_wr_8data(0x3033,0x24); //Sclk_mux1  --[1]   --- if=1,use PLL2_dac_clkuse,else use Sclk_mux0 output clock  ---- use PLL2_sys_clk=24
	i2c1_wr_8data(0x3106,0x11); //sys_pre_div--[3:2] ---00/01/10/11=/1/2/4/1                                       ---- 24/1=24
	//-------------------------
	// PLL other Setting
	//-------------------------
	i2c1_wr_8data(0x0308,0x00);// [0],   PLL1_bypass
	i2c1_wr_8data(0x0309,0x01);// [2:0], PLL1_cp
	i2c1_wr_8data(0x0311,0x00);// [0],   PLL2_bypass
	i2c1_wr_8data(0x3007,0x00);
	i2c1_wr_8data(0x3015,0x0F);
	i2c1_wr_8data(0x3016,0x08);
	i2c1_wr_8data(0x3017,0x10);
	i2c1_wr_8data(0x3021,0x03);
	i2c1_wr_8data(0x3022,0x01);
	i2c1_wr_8data(0x3023,0x00);
	i2c1_wr_8data(0x3024,0x10);
	i2c1_wr_8data(0x3030,0x00);
	//-------------------------
	// Window Setting
	//-------------------------
	i2c1_wr_8data(0x3031,0x0a);//mipi data format sel(RAW8/RAW10)
	i2c1_wr_8data(0x3841,0xFF);//ues auto mode(auto mode 0xff)
	i2c1_wr_8data(0x3808,0x07);//0x07
	i2c1_wr_8data(0x3809,0x80);//0x80--width 1920
	i2c1_wr_8data(0x380a,0x04);//05 0x04                            
	i2c1_wr_8data(0x380b,0x38);//a0 0x38--height 1080
	i2c1_wr_8data(0x380c,0x09);//0x09;0X08----H[15:8] ---- 2200?(2200-1920=280)
	i2c1_wr_8data(0x380d,0xc4);//0xc4;0X98----H[7:0]
	i2c1_wr_8data(0x380e,0x04);//04 06 0X05----V[15:8] ---- 1500(1500-1080=420)
	i2c1_wr_8data(0x380f,0xd0);//d0 68 0XDC----V[7:0]
	i2c1_wr_8data(0x3800,0x00);
	i2c1_wr_8data(0x3801,0xac);
	i2c1_wr_8data(0x3802,0x00);
	i2c1_wr_8data(0x3803,0x40);
	i2c1_wr_8data(0x3804,0x09);
	i2c1_wr_8data(0x3805,0x93);
	i2c1_wr_8data(0x3806,0x07);
	i2c1_wr_8data(0x3807,0x67);
	i2c1_wr_8data(0x3810,0x00);
	i2c1_wr_8data(0x3811,0x04);
	i2c1_wr_8data(0x3812,0x00);
	i2c1_wr_8data(0x3813,0x02);
	i2c1_wr_8data(0x3814,0x01);
	i2c1_wr_8data(0x3815,0x01);
	i2c1_wr_8data(0x382b,0x01);
	i2c1_wr_8data(0x3842,0x00);
	i2c1_wr_8data(0x3843,0x00);
	i2c1_wr_8data(0x3844,0x00);
	i2c1_wr_8data(0x3845,0x00); 
	//-------------------------
	// Other Setting
	//-------------------------  
	i2c1_wr_8data(0x3011,0x00); // I/O pad driver capability 
	i2c1_wr_8data(0x3000,0x00);
	i2c1_wr_8data(0x300e,0x00);
	i2c1_wr_8data(0x3008,0x00);
	i2c1_wr_8data(0x3002,0x61);
	i2c1_wr_8data(0x3010,0x40);
	i2c1_wr_8data(0x300d,0x00);
	i2c1_wr_8data(0x3005,0xf0);
	i2c1_wr_8data(0x303f,0x30);
	i2c1_wr_8data(0x3012,0x20);	
	i2c1_wr_8data(0x3004,0x6C);
	i2c1_wr_8data(0x3006,0x42);
	i2c1_wr_8data(0x3100,0x00);
	i2c1_wr_8data(0x3101,0x32);
	i2c1_wr_8data(0x3102,0x00);
	i2c1_wr_8data(0x3103,0x00);
	i2c1_wr_8data(0x3104,0x01);
	i2c1_wr_8data(0x3105,0x11);
	i2c1_wr_8data(0x3107,0x01);
	i2c1_wr_8data(0x3200,0x00);
	i2c1_wr_8data(0x3201,0x08);
	i2c1_wr_8data(0x3202,0x10);
	i2c1_wr_8data(0x3203,0x18);
	i2c1_wr_8data(0x3208,0x00);
	i2c1_wr_8data(0x3209,0x00);	
	i2c1_wr_8data(0x320a,0x00);
	i2c1_wr_8data(0x320b,0x11);
	i2c1_wr_8data(0x320c,0x02);
	i2c1_wr_8data(0x3820,0x80);
	i2c1_wr_8data(0x3821,0x40);
	i2c1_wr_8data(0x3814,0x01);
	i2c1_wr_8data(0x3815,0x01);
	i2c1_wr_8data(0x382a,0x01);
	i2c1_wr_8data(0x382b,0x01);
	i2c1_wr_8data(0x4502,0x40);
	i2c1_wr_8data(0x450a,0x00);
	#if 0
	i2c1_wr_8data(0x3820,0x80);
	//i2c1_wr_8data(0x3820,0x46);//mirror
	i2c1_wr_8data(0x3821,0x40);
	//i2c1_wr_8data(0x3821,0x06);//mirror
	i2c1_wr_8data(0x450b,0x00);
	//i2c1_wr_8data(0x450b,0x20);//mirror

	#endif
	#if 1
	i2c1_wr_8data(0x3820,0x46);//mirror
	i2c1_wr_8data(0x3821,0x06);//mirror
	i2c1_wr_8data(0x450b,0x20);//mirror
	#endif
	i2c1_wr_8data(0x4303,0x00);// test pattern [3]
	i2c1_wr_8data(0x4f00,0x00);
	i2c1_wr_8data(0x4f01,0x00);
	i2c1_wr_8data(0x4f03,0x00);
	i2c1_wr_8data(0x4f04,0x01);
	i2c1_wr_8data(0x4f05,0x40);
	i2c1_wr_8data(0x4f07,0xf0);
	//-------------------------
	// BLC Setting
	//------------------------- 
	i2c1_wr_8data(0x4000,0x01);
	i2c1_wr_8data(0x4001,0x60);
	i2c1_wr_8data(0x4002,0x00);
	i2c1_wr_8data(0x4003,0x00);
	i2c1_wr_8data(0x4004,0x00);
	i2c1_wr_8data(0x4005,0x02);
	i2c1_wr_8data(0x4006,0x00);
	i2c1_wr_8data(0x4007,0x02);
	i2c1_wr_8data(0x4008,0x02);
	i2c1_wr_8data(0x4009,0x0D);
	i2c1_wr_8data(0x400a,0x02);
	i2c1_wr_8data(0x400b,0x00);
	i2c1_wr_8data(0x400c,0x00);
	i2c1_wr_8data(0x400d,0x00);
	i2c1_wr_8data(0x400e,0x00);
	i2c1_wr_8data(0x400f,0x80);
	i2c1_wr_8data(0x4010,0xF0);
	i2c1_wr_8data(0x4011,0xF0);
	i2c1_wr_8data(0x4012,0x08);
	i2c1_wr_8data(0x4013,0x02);
	i2c1_wr_8data(0x4014,0x02);
	i2c1_wr_8data(0x4015,0x02);
	i2c1_wr_8data(0x4016,0x00);
	i2c1_wr_8data(0x4017,0x08);
	i2c1_wr_8data(0x4040,0x00);
	i2c1_wr_8data(0x4041,0x03);
	i2c1_wr_8data(0x4042,0x00);
	i2c1_wr_8data(0x4043,0x7A);
	i2c1_wr_8data(0x4044,0x00);
	i2c1_wr_8data(0x4045,0x7A);
	i2c1_wr_8data(0x4046,0x00);
	i2c1_wr_8data(0x4047,0x7A);
	i2c1_wr_8data(0x4048,0x00);
	i2c1_wr_8data(0x4049,0x7A);
	i2c1_wr_8data(0x404a,0x30);
	i2c1_wr_8data(0x404b,0x18);
	i2c1_wr_8data(0x404c,0x00);
	//-------------------------
	// Other Setting
	//------------------------- 
	i2c1_wr_8data(0x3d80,0x00);
	i2c1_wr_8data(0x3d81,0x30);
	i2c1_wr_8data(0x3d82,0xaa);
	i2c1_wr_8data(0x3d83,0x08);
	i2c1_wr_8data(0x3d84,0x80);
	i2c1_wr_8data(0x3d85,0x17);
	i2c1_wr_8data(0x3d86,0x02);
	i2c1_wr_8data(0x3d87,0x0a);
	i2c1_wr_8data(0x3d88,0x00);
	i2c1_wr_8data(0x3d89,0x00);
	i2c1_wr_8data(0x3d8a,0x00);
	i2c1_wr_8data(0x3d8b,0x00);
	i2c1_wr_8data(0x3d8c,0x71);
	i2c1_wr_8data(0x3d8d,0xea);
	i2c1_wr_8data(0x3d8e,0x00);
	i2c1_wr_8data(0x3d8f,0x00);
	i2c1_wr_8data(0x3d90,0x12);
	i2c1_wr_8data(0x3d91,0x06);
	i2c1_wr_8data(0x3b00,0x00);
	i2c1_wr_8data(0x3b02,0x00);
	i2c1_wr_8data(0x3b03,0x00);
	i2c1_wr_8data(0x3b04,0x00);
	i2c1_wr_8data(0x3b05,0x00);
	i2c1_wr_8data(0x0000,0x00);
	i2c1_wr_8data(0x4816,0x53);
	i2c1_wr_8data(0x5a08,0x06);
	i2c1_wr_8data(0x4700,0xa4);
	i2c1_wr_8data(0x4701,0x0a);
	i2c1_wr_8data(0x4704,0x00);
	i2c1_wr_8data(0x4705,0x00);
	i2c1_wr_8data(0x4706,0x04);
	i2c1_wr_8data(0x4707,0x10);
	i2c1_wr_8data(0x4708,0xf0);
	i2c1_wr_8data(0x4709,0x00);
	i2c1_wr_8data(0x470a,0x00);
	i2c1_wr_8data(0x470b,0x64);
	i2c1_wr_8data(0x470c,0x80);
	i2c1_wr_8data(0x470d,0x00);
	i2c1_wr_8data(0x4710,0x00);
	i2c1_wr_8data(0x3504,0x03);// AEC/AGC <--> MEC/MGC select(0x03=MEC/MGC)
	i2c1_wr_8data(0x3A01,0x01);
	i2c1_wr_8data(0x3A02,0x78);
	i2c1_wr_8data(0x3A03,0x68);
	i2c1_wr_8data(0x3A04,0x00);
	i2c1_wr_8data(0x3A05,0xf0);
	i2c1_wr_8data(0x3A07,0xf8);
	i2c1_wr_8data(0x4f04,0x01);
	i2c1_wr_8data(0x4f05,0x40);
	i2c1_wr_8data(0x4f07,0xf0);
	i2c1_wr_8data(0x4f10,0x12);
	i2c1_wr_8data(0x5000,0x50);
	i2c1_wr_8data(0x5001,0x01);
	i2c1_wr_8data(0x5002,0x28);
	i2c1_wr_8data(0x5003,0x20);
	i2c1_wr_8data(0x5004,0x0c);
	i2c1_wr_8data(0x501f,0x00);
	i2c1_wr_8data(0x5041,0x00);
	i2c1_wr_8data(0x5048,0x10);
	i2c1_wr_8data(0x502D,0x00);
	i2c1_wr_8data(0x5032,0x04);
	i2c1_wr_8data(0x5033,0x00);
	i2c1_wr_8data(0x5034,0x04);
	i2c1_wr_8data(0x5035,0x00);
	i2c1_wr_8data(0x5036,0x04);
	i2c1_wr_8data(0x5037,0x00);
	i2c1_wr_8data(0x5038,0x04);
	i2c1_wr_8data(0x5039,0x00);
	i2c1_wr_8data(0x5045,0x05);
	i2c1_wr_8data(0x5048,0x10);
	i2c1_wr_8data(0x5000,0x50);
	i2c1_wr_8data(0x5780,0xa4);
	i2c1_wr_8data(0x5781,0x0a);
	i2c1_wr_8data(0x5782,0x01);
	i2c1_wr_8data(0x5783,0x00);
	i2c1_wr_8data(0x5784,0x00);
	i2c1_wr_8data(0x5785,0x00);
	i2c1_wr_8data(0x5786,0x04);
	i2c1_wr_8data(0x5787,0x10);
	i2c1_wr_8data(0x5788,0xf0);
	i2c1_wr_8data(0x5789,0x00);
	i2c1_wr_8data(0x578a,0x00);
	i2c1_wr_8data(0x578b,0x64);
	i2c1_wr_8data(0x578c,0x80);
	i2c1_wr_8data(0x578d,0x00);
	i2c1_wr_8data(0x578e,0x00);
	i2c1_wr_8data(0x578f,0x00);
	i2c1_wr_8data(0x5790,0x00);
	i2c1_wr_8data(0x5791,0x00);
	i2c1_wr_8data(0x5792,0x00);
	i2c1_wr_8data(0x5793,0x00);
	i2c1_wr_8data(0x5794,0x00);
	i2c1_wr_8data(0x5795,0x00);
	i2c1_wr_8data(0x5796,0x00);
	i2c1_wr_8data(0x5797,0x00);
	i2c1_wr_8data(0x5798,0x00);
	i2c1_wr_8data(0x5799,0x00);
	i2c1_wr_8data(0x579a,0x00);
	i2c1_wr_8data(0x579b,0x00);
	i2c1_wr_8data(0x579c,0x00);
	i2c1_wr_8data(0x579d,0x00);
	i2c1_wr_8data(0x579e,0x00);
	i2c1_wr_8data(0x579f,0x00);
	i2c1_wr_8data(0x57a0,0x00);
	i2c1_wr_8data(0x57a1,0x00);
	i2c1_wr_8data(0x57a2,0x00);
	i2c1_wr_8data(0x57a3,0x00);
	i2c1_wr_8data(0x57a4,0x00);
	i2c1_wr_8data(0x57a5,0x00);
	i2c1_wr_8data(0x57a6,0x00);
	i2c1_wr_8data(0x57a7,0x00);
	i2c1_wr_8data(0x5a00,0x00);
	i2c1_wr_8data(0x5a01,0x00);
	i2c1_wr_8data(0x5a02,0x00);
	i2c1_wr_8data(0x5a03,0x00);
	i2c1_wr_8data(0x5a04,0x0c);
	i2c1_wr_8data(0x5a05,0xe0);
	i2c1_wr_8data(0x5a06,0x09);
	i2c1_wr_8data(0x5a07,0xb0);
	i2c1_wr_8data(0x5a08,0x06);

	//-------------------------
	// MEC/MGC setting
	//-------------------------
	i2c1_wr_8data(0x3504,0x03); 
	i2c1_wr_8data(0x3500,0x00);// long exposure[19:16]
	i2c1_wr_8data(0x3501,0x0a);// long exposure[15: 8]
	i2c1_wr_8data(0x3502,0x00);// long exposure[7 : 0]
	i2c1_wr_8data(0x3503,0x00);// input gain as real gain format(gain=long gain/128)
	i2c1_wr_8data(0x3504,0x03);// 0x03 = MEC/MGC mode
	i2c1_wr_8data(0x3505,0x83);
	i2c1_wr_8data(0x3506,0x00);
	i2c1_wr_8data(0x3507,0x00);
	i2c1_wr_8data(0x3508,0x00);// long gain[12:8]
	i2c1_wr_8data(0x3509,0x00);// long gain[7:0]
	i2c1_wr_8data(0x350a,0x04);
	i2c1_wr_8data(0x350b,0x00);
	i2c1_wr_8data(0x350c,0x00);
	i2c1_wr_8data(0x350d,0x80);
	i2c1_wr_8data(0x350e,0x04);
	i2c1_wr_8data(0x350f,0x00);
	i2c1_wr_8data(0x3510,0x00);
	i2c1_wr_8data(0x3511,0x02);
	i2c1_wr_8data(0x3512,0x00);
	i2c1_wr_8data(0x3600,0x70);
	i2c1_wr_8data(0x3601,0xc8);
	i2c1_wr_8data(0x3602,0x50);
	i2c1_wr_8data(0x3603,0x0c);
	i2c1_wr_8data(0x3604,0x0c);
	i2c1_wr_8data(0x3610,0x88);
	i2c1_wr_8data(0x3611,0x58);
	i2c1_wr_8data(0x3612,0x48);
	i2c1_wr_8data(0x3613,0x0a);
	i2c1_wr_8data(0x3614,0x5b);
	i2c1_wr_8data(0x3615,0x96);
	i2c1_wr_8data(0x3616,0x79);
	i2c1_wr_8data(0x3617,0x07);
	i2c1_wr_8data(0x3618,0x2a);
	i2c1_wr_8data(0x3619,0x0c);
	i2c1_wr_8data(0x361a,0x00);
	i2c1_wr_8data(0x361b,0x00);
	i2c1_wr_8data(0x361c,0x00);
	i2c1_wr_8data(0x361d,0x00);
	i2c1_wr_8data(0x361e,0x00);
	i2c1_wr_8data(0x361f,0x00);
	i2c1_wr_8data(0x3620,0x81);
	i2c1_wr_8data(0x3621,0xd0);
	i2c1_wr_8data(0x3622,0x00);
	i2c1_wr_8data(0x3623,0x00);
	i2c1_wr_8data(0x3624,0x20);
	i2c1_wr_8data(0x3625,0x04);
	i2c1_wr_8data(0x3630,0x44);
	i2c1_wr_8data(0x3631,0x60);
	i2c1_wr_8data(0x3632,0x00);
	i2c1_wr_8data(0x3633,0x13);
	i2c1_wr_8data(0x3634,0x13);
	i2c1_wr_8data(0x3635,0x13);
	i2c1_wr_8data(0x3636,0x13);
	i2c1_wr_8data(0x3640,0x00);
	i2c1_wr_8data(0x3641,0x00);
	i2c1_wr_8data(0x3642,0x00);
	i2c1_wr_8data(0x3643,0x00);
	i2c1_wr_8data(0x3644,0x00);
	i2c1_wr_8data(0x3645,0x13);
	i2c1_wr_8data(0x3646,0x82);
	i2c1_wr_8data(0x3647,0x10);
	i2c1_wr_8data(0x3648,0x00);
	i2c1_wr_8data(0x3649,0x38);
	i2c1_wr_8data(0x364a,0x27);
	i2c1_wr_8data(0x364b,0x88);
	i2c1_wr_8data(0x364c,0x00);
	i2c1_wr_8data(0x364d,0x00);
	i2c1_wr_8data(0x364e,0x00);
	i2c1_wr_8data(0x364f,0x00);
	i2c1_wr_8data(0x3650,0x00);
	i2c1_wr_8data(0x3651,0x00);
	i2c1_wr_8data(0x3652,0xff);
	i2c1_wr_8data(0x3653,0x34);
	i2c1_wr_8data(0x3654,0x00);
	i2c1_wr_8data(0x3655,0x20);
	i2c1_wr_8data(0x3656,0xff);
	i2c1_wr_8data(0x3657,0xc4);
	i2c1_wr_8data(0x3658,0x00);
	i2c1_wr_8data(0x3659,0x00);
	i2c1_wr_8data(0x365a,0xff);
	i2c1_wr_8data(0x365b,0xff);
	i2c1_wr_8data(0x365c,0x00);
	i2c1_wr_8data(0x365d,0x00);
	i2c1_wr_8data(0x365e,0xff);
	i2c1_wr_8data(0x365f,0x00);
	i2c1_wr_8data(0x3669,0x04);
	i2c1_wr_8data(0x366a,0x00);
	i2c1_wr_8data(0x366b,0xff);
	i2c1_wr_8data(0x366c,0x00);
	i2c1_wr_8data(0x366d,0x00);
	i2c1_wr_8data(0x366e,0x10);
	i2c1_wr_8data(0x366f,0x80);
	i2c1_wr_8data(0x3700,0x28);
	i2c1_wr_8data(0x3701,0x10);
	i2c1_wr_8data(0x3702,0x3a);
	i2c1_wr_8data(0x3703,0x19);
	i2c1_wr_8data(0x3704,0x10);
	i2c1_wr_8data(0x3705,0x00);
	i2c1_wr_8data(0x3706,0x66);
	i2c1_wr_8data(0x3707,0x08);
	i2c1_wr_8data(0x3708,0x34);
	i2c1_wr_8data(0x3709,0x40);
	i2c1_wr_8data(0x370a,0x01);
	i2c1_wr_8data(0x370b,0x1b);
	i2c1_wr_8data(0x370c,0x07);
	i2c1_wr_8data(0x370d,0x00);
	i2c1_wr_8data(0x370e,0x00);
	i2c1_wr_8data(0x370f,0x0a);         
	i2c1_wr_8data(0x3710,0x30);
	i2c1_wr_8data(0x3711,0x1c);
	i2c1_wr_8data(0x3712,0x44);
	i2c1_wr_8data(0x3713,0x00);
	i2c1_wr_8data(0x3714,0x24);
	i2c1_wr_8data(0x3715,0x00);
	i2c1_wr_8data(0x3716,0x00);
	i2c1_wr_8data(0x3717,0x03);
	i2c1_wr_8data(0x3718,0x14);
	i2c1_wr_8data(0x3719,0x31);
	i2c1_wr_8data(0x371a,0x3e);
	i2c1_wr_8data(0x371b,0x80);
	i2c1_wr_8data(0x371c,0x45);
	i2c1_wr_8data(0x371d,0x05);
	i2c1_wr_8data(0x371e,0x31);
	i2c1_wr_8data(0x371f,0x7f);         
	i2c1_wr_8data(0x3720,0x0a);
	i2c1_wr_8data(0x3721,0x0a);
	i2c1_wr_8data(0x3722,0x06);
	i2c1_wr_8data(0x3723,0x0a);
	i2c1_wr_8data(0x3724,0x0c);
	i2c1_wr_8data(0x3725,0x02);
	i2c1_wr_8data(0x3726,0x0c);
	i2c1_wr_8data(0x3727,0x0a);
	i2c1_wr_8data(0x3728,0x0a);
	i2c1_wr_8data(0x3729,0x03);
	i2c1_wr_8data(0x372a,0x06);
	i2c1_wr_8data(0x372b,0xa6);
	i2c1_wr_8data(0x372c,0xa6);
	i2c1_wr_8data(0x372d,0xa6);
	i2c1_wr_8data(0x372e,0x0c);
	i2c1_wr_8data(0x372f,0x20);        
	i2c1_wr_8data(0x3730,0x02);
	i2c1_wr_8data(0x3731,0x0c);
	i2c1_wr_8data(0x3732,0x28);
	i2c1_wr_8data(0x3733,0x00);
	i2c1_wr_8data(0x3734,0x40);
	i2c1_wr_8data(0x3735,0x00);
	i2c1_wr_8data(0x3736,0x30);
	i2c1_wr_8data(0x3737,0x00);
	i2c1_wr_8data(0x3738,0x00);
	i2c1_wr_8data(0x3739,0x05);
	i2c1_wr_8data(0x373a,0x05);
	i2c1_wr_8data(0x373b,0x06);
	i2c1_wr_8data(0x373c,0x0a);
	i2c1_wr_8data(0x373d,0x20);
	i2c1_wr_8data(0x373e,0x06);
	i2c1_wr_8data(0x373f,0xa0);
	i2c1_wr_8data(0x3757,0x0e);
	i2c1_wr_8data(0x3758,0x00);
	i2c1_wr_8data(0x3759,0x4c);
	i2c1_wr_8data(0x375a,0x0c);
	i2c1_wr_8data(0x375b,0x0e);
	i2c1_wr_8data(0x375c,0x20);
	i2c1_wr_8data(0x375d,0x04);
	i2c1_wr_8data(0x375e,0x00);
	i2c1_wr_8data(0x375f,0x28);         
	i2c1_wr_8data(0x3760,0x00);
	i2c1_wr_8data(0x3761,0x00);
	i2c1_wr_8data(0x3762,0x00);
	i2c1_wr_8data(0x3763,0x00);
	i2c1_wr_8data(0x3764,0x00);
	i2c1_wr_8data(0x3765,0x00);
	i2c1_wr_8data(0x3766,0x5f);
	i2c1_wr_8data(0x3767,0x00);
	i2c1_wr_8data(0x3768,0x00);
	i2c1_wr_8data(0x3769,0x22);
	i2c1_wr_8data(0x376a,0x2a);
	i2c1_wr_8data(0x376b,0x00);
	i2c1_wr_8data(0x376c,0x00);
	i2c1_wr_8data(0x376d,0x00);
	i2c1_wr_8data(0x376e,0x00);
	i2c1_wr_8data(0x376f,0x02);          
	i2c1_wr_8data(0x3770,0x08);
	i2c1_wr_8data(0x3771,0x00);
	i2c1_wr_8data(0x3772,0x46);
	i2c1_wr_8data(0x3773,0x08);
	i2c1_wr_8data(0x3774,0x1f);
	i2c1_wr_8data(0x3775,0x13);
	i2c1_wr_8data(0x3776,0x06);
	i2c1_wr_8data(0x3777,0x00);
	i2c1_wr_8data(0x3778,0x17);
	i2c1_wr_8data(0x3779,0x02);
	i2c1_wr_8data(0x377a,0x0c);
	i2c1_wr_8data(0x377b,0x00);
	i2c1_wr_8data(0x377c,0x00);
	i2c1_wr_8data(0x377d,0x00);
	i2c1_wr_8data(0x377e,0x00);
	i2c1_wr_8data(0x377f,0x00); 
	i2c1_wr_8data(0x37a0,0x88);
	i2c1_wr_8data(0x37a1,0x5c);
	i2c1_wr_8data(0x37a2,0x7a);
	i2c1_wr_8data(0x37a3,0x00);
	i2c1_wr_8data(0x37a4,0x00);
	i2c1_wr_8data(0x37a5,0x00);
	i2c1_wr_8data(0x37a6,0x00);
	i2c1_wr_8data(0x37a7,0x88);
	i2c1_wr_8data(0x37a8,0x70);
	i2c1_wr_8data(0x37a9,0x98);
	i2c1_wr_8data(0x37aa,0x88);
	i2c1_wr_8data(0x37ab,0x48);
	i2c1_wr_8data(0x37ac,0x00);
	i2c1_wr_8data(0x37ad,0x00);
	i2c1_wr_8data(0x37ae,0x00);
	i2c1_wr_8data(0x37af,0x00); 
	i2c1_wr_8data(0x37c0,0x62);
	i2c1_wr_8data(0x37c1,0x62);
	i2c1_wr_8data(0x37c2,0x04);
	i2c1_wr_8data(0x37c3,0xf0);
	i2c1_wr_8data(0x37c4,0x00);
	i2c1_wr_8data(0x37c5,0x00);
	i2c1_wr_8data(0x37c6,0x04);
	i2c1_wr_8data(0x37c7,0x00);
	i2c1_wr_8data(0x37c8,0x00);
	i2c1_wr_8data(0x37c9,0x00);
	i2c1_wr_8data(0x37ca,0x46);
	i2c1_wr_8data(0x37cb,0x00);
	i2c1_wr_8data(0x37cc,0x00);
	i2c1_wr_8data(0x37cd,0x00);
	i2c1_wr_8data(0x37ce,0x00);
	i2c1_wr_8data(0x37cf,0x00); 
	i2c1_wr_8data(0x4200,0x08);
	i2c1_wr_8data(0x4201,0x00);
	i2c1_wr_8data(0x4202,0x00);
	i2c1_wr_8data(0x4203,0x80);
	i2c1_wr_8data(0x4300,0xff);
	i2c1_wr_8data(0x4301,0x00);
	i2c1_wr_8data(0x4302,0x0f);
	i2c1_wr_8data(0x4303,0x00);
	i2c1_wr_8data(0x4304,0x08);
	i2c1_wr_8data(0x4305,0x40);
	i2c1_wr_8data(0x4306,0x0e);
	i2c1_wr_8data(0x4307,0x30);
	i2c1_wr_8data(0x4308,0x00);
	i2c1_wr_8data(0x4309,0x00);
	i2c1_wr_8data(0x430a,0x00);
	i2c1_wr_8data(0x430b,0x00);
	i2c1_wr_8data(0x430c,0x00);
	i2c1_wr_8data(0x430d,0x00);
	i2c1_wr_8data(0x430e,0x00);
	i2c1_wr_8data(0x430f,0x00);
	i2c1_wr_8data(0x4310,0x02);
	i2c1_wr_8data(0x4311,0x04);
	i2c1_wr_8data(0x4312,0x00);
	i2c1_wr_8data(0x4313,0x00);
	i2c1_wr_8data(0x4314,0x00);
	i2c1_wr_8data(0x4315,0x00);
	i2c1_wr_8data(0x4316,0x00);
	i2c1_wr_8data(0x4322,0x00);
	i2c1_wr_8data(0x4323,0x00);
	i2c1_wr_8data(0x4324,0x00);
	i2c1_wr_8data(0x4325,0x00);
	i2c1_wr_8data(0x4326,0x00);
	i2c1_wr_8data(0x4327,0x00);
	i2c1_wr_8data(0x4328,0x00);
	i2c1_wr_8data(0x4329,0x00);
	i2c1_wr_8data(0x4800,0x5c);//[4] enable line short package for each line
	i2c1_wr_8data(0x4801,0x00);
	i2c1_wr_8data(0x4802,0x00);
	i2c1_wr_8data(0x4803,0x00);
	i2c1_wr_8data(0x4804,0x04);
	i2c1_wr_8data(0x4805,0x00);
	i2c1_wr_8data(0x4806,0x00);
	i2c1_wr_8data(0x4807,0x03);
	i2c1_wr_8data(0x4808,0x1a);
	i2c1_wr_8data(0x4809,0x00);
	i2c1_wr_8data(0x480a,0x00);
	i2c1_wr_8data(0x480b,0x00);
	i2c1_wr_8data(0x480c,0x00);
	i2c1_wr_8data(0x480d,0x00);
	i2c1_wr_8data(0x480e,0x00);
	i2c1_wr_8data(0x480f,0x00);
	i2c1_wr_8data(0x4810,0xff);
	i2c1_wr_8data(0x4811,0xff);
	i2c1_wr_8data(0x4812,0x00);
	i2c1_wr_8data(0x4813,0x00);
	i2c1_wr_8data(0x4814,0x2a);
	i2c1_wr_8data(0x4815,0x00);
	i2c1_wr_8data(0x4816,0x53);
	i2c1_wr_8data(0x4817,0x00);
	i2c1_wr_8data(0x4818,0x00);
	i2c1_wr_8data(0x4819,0x70);
	i2c1_wr_8data(0x481a,0x00);
	i2c1_wr_8data(0x481b,0x3c);
	i2c1_wr_8data(0x481c,0x01);
	i2c1_wr_8data(0x481d,0x2c);
	i2c1_wr_8data(0x481e,0x5f);
	i2c1_wr_8data(0x481f,0x40);
	i2c1_wr_8data(0x4820,0x00);
	i2c1_wr_8data(0x4821,0x3c);
	i2c1_wr_8data(0x4822,0x00);
	i2c1_wr_8data(0x4823,0x3c);
	i2c1_wr_8data(0x4824,0x00);
	i2c1_wr_8data(0x4825,0x32);
	i2c1_wr_8data(0x4826,0x32);
	i2c1_wr_8data(0x4827,0x55);
	i2c1_wr_8data(0x4828,0x00);
	i2c1_wr_8data(0x4829,0x64);
	i2c1_wr_8data(0x482a,0x06);
	i2c1_wr_8data(0x482b,0x04);
	i2c1_wr_8data(0x482c,0x00);
	i2c1_wr_8data(0x482d,0x00);
	i2c1_wr_8data(0x482e,0x34);
	i2c1_wr_8data(0x482f,0x00);
	i2c1_wr_8data(0x4830,0x00);
	i2c1_wr_8data(0x4831,0x64);
	i2c1_wr_8data(0x4832,0x00);
	i2c1_wr_8data(0x4833,0x08);
	i2c1_wr_8data(0x4834,0x00);
	i2c1_wr_8data(0x4835,0x00);
	i2c1_wr_8data(0x4836,0x00);
	i2c1_wr_8data(0x4837,0x13);
	i2c1_wr_8data(0x4838,0x00);
	i2c1_wr_8data(0x4839,0x00);
	i2c1_wr_8data(0x483a,0x00);
	i2c1_wr_8data(0x483b,0x00);
	i2c1_wr_8data(0x483c,0x02);
	i2c1_wr_8data(0x483d,0x00);
	i2c1_wr_8data(0x483e,0x00);
	i2c1_wr_8data(0x483f,0x00);
	i2c1_wr_8data(0x4840,0x00);
	i2c1_wr_8data(0x4841,0x00);
	i2c1_wr_8data(0x4842,0x00);
	i2c1_wr_8data(0x4843,0x00);
	i2c1_wr_8data(0x4844,0x00);
	i2c1_wr_8data(0x4845,0x00);
	i2c1_wr_8data(0x4846,0x00);
	i2c1_wr_8data(0x4847,0x00);
	i2c1_wr_8data(0x4848,0x00);
	i2c1_wr_8data(0x4849,0x00);
	i2c1_wr_8data(0x484a,0x3f);
	i2c1_wr_8data(0x484b,0x07);
	i2c1_wr_8data(0x484c,0x03);
	i2c1_wr_8data(0x484d,0xb6);
	i2c1_wr_8data(0x484e,0x10);
	i2c1_wr_8data(0x484f,0x55);
	i2c1_wr_8data(0x4850,0x10);
	i2c1_wr_8data(0x4851,0x32);
	i2c1_wr_8data(0x4852,0x00);
	i2c1_wr_8data(0x4853,0x76);
	i2c1_wr_8data(0x4900,0x00);
	i2c1_wr_8data(0x4901,0x00);
	i2c1_wr_8data(0x4902,0x00);
	i2c1_wr_8data(0x4903,0x00);
	i2c1_wr_8data(0x4f00,0x00);
	i2c1_wr_8data(0x4f01,0x00);
	i2c1_wr_8data(0x4f02,0x00);
	i2c1_wr_8data(0x4f03,0x00);
	i2c1_wr_8data(0x4f04,0x01);
	i2c1_wr_8data(0x4f05,0x40);
	i2c1_wr_8data(0x4f06,0x00);
	i2c1_wr_8data(0x4f07,0xf0);
	i2c1_wr_8data(0x4f08,0x11);
	i2c1_wr_8data(0x4f09,0x11);
	i2c1_wr_8data(0x4f0a,0x11);
	i2c1_wr_8data(0x4f0b,0x11);
	i2c1_wr_8data(0x4f0c,0x11);
	i2c1_wr_8data(0x4f0d,0x11);
	i2c1_wr_8data(0x4f0e,0x11);
	i2c1_wr_8data(0x4f0f,0x11);
	i2c1_wr_8data(0x4f10,0x12);
	i2c1_wr_8data(0x5900,0x01);
	i2c1_wr_8data(0x5901,0x00);
	i2c1_wr_8data(0x4500,0x58);
	i2c1_wr_8data(0x4501,0x04);
	i2c1_wr_8data(0x4502,0x40); 
	i2c1_wr_8data(0x4503,0x10);
	i2c1_wr_8data(0x3018,0x32);
	i2c1_wr_8data(0x3019,0x00);
	i2c1_wr_8data(0x301a,0xf0);
	i2c1_wr_8data(0x301b,0xf0);
	i2c1_wr_8data(0x301c,0xf0);
	i2c1_wr_8data(0x301d,0xf0);
	i2c1_wr_8data(0x301e,0xf0);
	i2c1_wr_8data(0x301f,0x00);
	i2c1_wr_8data(0x3034,0x00);
	i2c1_wr_8data(0x3035,0x18);
	i2c1_wr_8data(0x3036,0x01);
	i2c1_wr_8data(0x3037,0x00);
	i2c1_wr_8data(0x3038,0x60);
	i2c1_wr_8data(0x3039,0xf0);
	i2c1_wr_8data(0x303a,0xf0);
	i2c1_wr_8data(0x303b,0xf0);
	i2c1_wr_8data(0x303c,0xff);
	i2c1_wr_8data(0x303d,0xf0);
	i2c1_wr_8data(0x303e,0xff);
	i2c1_wr_8data(0x3040,0xf0);
	i2c1_wr_8data(0x3041,0x00);
	i2c1_wr_8data(0x3042,0xf0);
	i2c1_wr_8data(0x3043,0x00);
	i2c1_wr_8data(0x3822,0x48);
	i2c1_wr_8data(0x3823,0x08);
	i2c1_wr_8data(0x3824,0x00);
	i2c1_wr_8data(0x3825,0x20);
	i2c1_wr_8data(0x3826,0x00);
	i2c1_wr_8data(0x3827,0x08);
	i2c1_wr_8data(0x3828,0x00);
	i2c1_wr_8data(0x3829,0x00);
	//-----------------------------------------------------------
	i2c1_wr_8data(0x0100,0x01);//streaming mode enable
	delay(2000);
	//-----------------------------------------------------------
	// OV2281 I2C config end
	//-----------------------------------------------------------

}


#define TIME_MAX              0x7fff
#define TIME_MIN              0x0600
uint32_t shutter = (TIME_MAX + TIME_MIN)/2;
uint8_t   SensorReady   = 0     ;
uint8_t frame=0;

/**
  * @brief  This function handles DSP2 exception.
  * @param  None
  * @retval None
  */
void DSP2_IRQHandler(void)
{

	SensorReady = 1        ;
	shutter = shutter *( (uint32_t)ISP_SHUTTLE_CTRL);
	shutter = shutter >> 8;
	
	if( shutter > TIME_MAX )
	{
		shutter = TIME_MAX;
	}
	else if( shutter < TIME_MIN ) 	
	{
		shutter = TIME_MIN;
	}

	//i2c1_wr_8data(0x3508, (uint8_t)( ISP_GAIN_CTRL >> 8));
	//i2c1_wr_8data(0x3509, (uint8_t)ISP_GAIN_CTRL);
	
	i2c1_wr_8data(0x3501, (uint8_t)( shutter >> 8    )  );
	i2c1_wr_8data(0x3502, (uint8_t)( shutter &  0xff )  );
	
//i2c1_wr_8data(0x3501, 0x30)  ;
//i2c1_wr_8data(0x3502, 0xf0 ) ; 	
	
	
}

